<!-- <!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InFi Chatbot</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #1890ff;
            --secondary-color: #096dd9;
            --accent-color: #13c2c2;
            --text-color: #333;
            --light-text: #f0f0f0;
            --background: #f5f5f5;
            --card-bg: #ffffff;
            --border-color: #d9d9d9;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--background);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            color: var(--text-color);
        }

        .mic-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            transition: all 0.5s ease-in-out;
            z-index: 1000;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background-color: var(--primary-color);
            box-shadow: var(--shadow);
        }

        .mic-container.active {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 300px;
            border-radius: 50%;
            background-color: var(--primary-color);
        }

        .mic-container.active #mic-btn {
            width: 280px;
            height: 280px;
            border-radius: 50%;
        }

        .mic-container.active #mic-btn img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .mic-container.active .mic-status {
            font-size: 18px;
            margin-top: 15px;
            color: var(--light-text);
            font-weight: 500;
        }

        #mic-btn {
            background: none;
            border: none;
            cursor: pointer;
            outline: none;
            padding: 0;
            width: 100px;
            height: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease-in-out;
            border-radius: 50%;
            background-color: var(--primary-color);
        }

        #mic-btn img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .mic-status {
            margin-top: 10px;
            font-size: 16px;
            color: var(--light-text);
            text-align: center;
            display: none;
            font-weight: 500;
        }

        .mic-container.active .mic-status {
            display: block;
        }

        .chat-container {
            display: none;
            flex-direction: column;
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
            background: var(--card-bg);
            padding: 24px;
            border-radius: 12px;
            height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            transition: all 0.3s ease-in-out;
        }

        .chat-container h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 24px;
            font-size: 24px;
            font-weight: 600;
        }

        #chat-window {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 8px;
        }

        #messages {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .user-message {
            background: var(--primary-color);
            align-self: flex-end;
            color: var(--light-text);
            text-align: right;
            border-radius: 12px 12px 0 12px;
            box-shadow: var(--shadow);
            border: none;
        }

        .bot-message {
            background: var(--card-bg);
            align-self: flex-start;
            color: var(--text-color);
            text-align: left;
            border-radius: 12px 12px 12px 0;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        #messages>div {
            padding: 12px 16px;
            max-width: 75%;
            line-height: 1.5;
            word-wrap: break-word;
            font-size: 15px;
        }

        form {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }

        input#prompt {
            flex: 1;
            padding: 12px 16px;
            font-size: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--card-bg);
            color: var(--text-color);
            outline: none;
            transition: all 0.3s;
        }

        input#prompt:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
        }

        form button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        form button:hover {
            background-color: var(--secondary-color);
        }

        #toggle-chat-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--primary-color);
            border: none;
            cursor: pointer;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            z-index: 1001;
            transition: all 0.3s;
        }

        #toggle-chat-btn:hover {
            background-color: var(--secondary-color);
            transform: scale(1.05);
        }

        #menu-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--primary-color);
            border: none;
            cursor: pointer;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            z-index: 1001;
            transition: all 0.3s;
        }

        #menu-btn:hover {
            background-color: var(--secondary-color);
            transform: scale(1.05);
        }

        @media (max-width: 768px) {
            .mic-container {
                bottom: 10px;
                width: 100px;
                height: 100px;
            }

            .mic-container.active {
                width: 250px;
                height: 250px;
            }

            .mic-container.active #mic-btn {
                width: 230px;
                height: 230px;
            }

            #mic-btn {
                width: 80px;
                height: 80px;
            }

            #toggle-chat-btn,
            #menu-btn {
                top: 20px;
                bottom: auto;
            }

            #toggle-chat-btn {
                right: 20px;
            }

            #menu-btn {
                left: 20px;
            }

            .chat-container {
                height: 90vh;
                border-radius: 0;
                padding: 16px;
            }
        }

        /* Typing indicators */
        .typing-indicator {
            color: #999;
            font-style: italic;
            font-size: 14px;
            padding: 8px 16px;
        }

        .user-typing {
            align-self: flex-end;
        }

        .bot-typing {
            align-self: flex-start;
        }
    </style>
</head>

<body>
    <button id="menu-btn">
        <i class="fas fa-bars"></i>
    </button>
    <button id="toggle-chat-btn" onclick="toggleChat()">
        <i class="fas fa-keyboard"></i>
    </button>
    <div class="mic-container">
        <button id="mic-btn" onclick="handleMicClick()">
            <img src="/static/assets/voicegif.gif" alt="Voice GIF">
        </button>
        <div class="mic-status"></div>
    </div>
    <div class="chat-container">
        <h1>InFi Chatbot</h1>
        <div id="chat-window">
            <div id="messages"></div>
        </div>
        <form onsubmit="event.preventDefault(); sendMessage();">
            <input type="text" id="prompt" placeholder="Type your message here..." />
            <button type="submit">
                <i class="fas fa-paper-plane"></i>
            </button>
        </form>
    </div>

    <script>
        let recognition;
        let isListening = false;
        let isBotSpeaking = false;
        let isFirstClick = true;
        let selectedVoice = null;
        let conversationActive = false;
        let wakeWordDetected = false;

        function loadVoices() {
            const voices = window.speechSynthesis.getVoices();
            selectedVoice = voices.find(voice => voice.name.toLowerCase().includes('neerja'));

            if (!selectedVoice) {
                console.warn("Neerja voice not found. Using default voice.");
            }
        }

        if (window.speechSynthesis.getVoices().length > 0) {
            loadVoices();
        } else {
            window.speechSynthesis.onvoiceschanged = loadVoices;
        }

        function sendMessage() {
            const prompt = document.getElementById('prompt').value;
            const messages = document.getElementById('messages');
            if (!prompt.trim()) return;

            const userMessage = document.createElement('div');
            userMessage.className = 'user-message';
            userMessage.textContent = prompt;
            messages.appendChild(userMessage);
            scrollToBottom(); // Auto-scroll after adding user message

            const userTypingIndicator = document.createElement('div');
            userTypingIndicator.className = 'typing-indicator user-typing';
            userTypingIndicator.textContent = 'You are typing...';
            messages.appendChild(userTypingIndicator);
            scrollToBottom(); // Auto-scroll after adding typing indicator

            document.getElementById('prompt').value = '';

            axios.post('/api/gmtt/', { prompt: prompt, job: "general" })
                .then(response => {
                    messages.removeChild(userTypingIndicator);

                    const botTypingIndicator = document.createElement('div');
                    botTypingIndicator.className = 'typing-indicator bot-typing';
                    botTypingIndicator.textContent = 'Bot is typing...';
                    messages.appendChild(botTypingIndicator);
                    scrollToBottom(); // Auto-scroll after adding bot typing indicator

                    setTimeout(() => {
                        messages.removeChild(botTypingIndicator);

                        const botMessage = document.createElement('div');
                        botMessage.className = 'bot-message';
                        botMessage.textContent = response.data.text;
                        messages.appendChild(botMessage);
                        scrollToBottom(); // Auto-scroll after adding bot message

                        if (["bye", "exit", "goodbye"].includes(prompt.toLowerCase())) {
                            handleExitCommand();
                        } else {
                            speakResponse(response.data.text);
                        }
                    }, 1000);
                })
                .catch(error => {
                    console.error(error);
                    messages.removeChild(userTypingIndicator);

                    const botMessage = document.createElement('div');
                    botMessage.className = 'bot-message';
                    botMessage.textContent = "Something went wrong. Please try again.";
                    messages.appendChild(botMessage);
                    scrollToBottom(); // Auto-scroll after error message
                });
        }

        function speakResponse(text) {
            window.speechSynthesis.cancel();

            if (isListening) {
                recognition.stop();
                isListening = false;
                updateMicButton();
            }

            const speech = new SpeechSynthesisUtterance(text);
            speech.lang = 'en-IN';

            if (selectedVoice) {
                speech.voice = selectedVoice;
            }

            speech.onstart = () => {
                isBotSpeaking = true;
                document.getElementById('mic-btn').innerHTML = '<img src="/static/assets/voicegif.gif" alt="Voice Active GIF">';
            };

            speech.onend = () => {
                isBotSpeaking = false;
                if (conversationActive && !isListening) {
                    // Add a small delay before restarting recognition
                    setTimeout(() => {
                        try {
                            if (!isListening) {
                                recognition.start();
                                isListening = true;
                                document.getElementById('mic-btn').innerHTML = '<img src="/static/assets/voicegif.gif" alt="Voice GIF">';
                            }
                        } catch (e) {
                            console.log("Recognition start error:", e);
                            // If start fails, try again after a short delay
                            setTimeout(() => {
                                if (!isListening) {
                                    recognition.start();
                                    isListening = true;
                                    document.getElementById('mic-btn').innerHTML = '<img src="/static/assets/voicegif.gif" alt="Voice GIF">';
                                }
                            }, 500);
                        }
                    }, 500);
                }
            };

            window.speechSynthesis.speak(speech);
        }

        function updateMicButton() {
            const micBtn = document.getElementById('mic-btn');
            if (isBotSpeaking) {
                micBtn.innerHTML = '<img src="/static/assets/voicegif.gif" alt="Voice Active GIF">';
            } else {
                micBtn.innerHTML = isListening
                    ? '<img src="/static/assets/voicegif.gif" alt="Voice GIF">'
                    : '<img src="/static/assets/voicegif.gif" alt="Voice Inactive GIF">';
            }
        }

        function handleMicClick() {
            const micContainer = document.querySelector('.mic-container');
            const micStatus = document.querySelector('.mic-status');

            if (!conversationActive) {
                // First interaction - start conversation
                micContainer.classList.add('active');
                startVoiceRecognition(true);
                conversationActive = true;
                wakeWordDetected = true; // Consider click as wake word
                return;
            }

            if (isBotSpeaking) {
                // Requirement 3: Click while bot is speaking
                window.speechSynthesis.cancel();
                isBotSpeaking = false;
                startVoiceRecognition();
            } else {
                // Toggle between bottom and center positions
                if (micContainer.classList.contains('active')) {
                    // Currently in center - move to bottom
                    micContainer.classList.remove('active');
                    if (isListening) {
                        recognition.stop();
                        isListening = false;
                    }
                } else {
                    // Currently in bottom - move to center and restart
                    micContainer.classList.add('active');
                    startVoiceRecognition();
                }
            }
        }

        function startVoiceRecognition(initialStart = false) {
            if (!('webkitSpeechRecognition' in window)) {
                alert('Speech recognition is not supported in this browser.');
                return;
            }

            if (isListening && !initialStart) {
                recognition.stop();
                isListening = false;
                updateMicButton();
                return;
            }

            // If recognition already exists and is running, stop it first
            if (recognition && isListening) {
                recognition.stop();
                isListening = false;
            }

            recognition = new webkitSpeechRecognition();
            recognition.lang = 'en-IN';
            recognition.interimResults = false;
            recognition.continuous = true;

            recognition.onstart = function () {
                isListening = true;
                document.getElementById('mic-btn').innerHTML = '<img src="/static/assets/voicegif.gif" alt="Voice Active GIF">';
                document.querySelector('.mic-status').textContent = 'Listening...';
                
                if (!wakeWordDetected && !initialStart) {
                    document.querySelector('.mic-status').textContent = 'Hello! I am Infi';
                }
            };

            recognition.onresult = function (event) {
                const transcript = event.results[event.results.length - 1][0].transcript.trim();
                if (transcript) {
                    // Check for wake word if conversation hasn't started yet
                    if (!wakeWordDetected) {
                        const wakeWords = [
                            "hi infi", "hi infee", "hi infy", "hi infie", "hi infey",
                            "hii infi", "hii infee", "hii infy", "hii infie", "hii infey",
                            "hello infi", "hello infee", "hello infy", "hello infie", "hello infey",
                            "helloo infi", "helloo infee", "helloo infy", "helloo infie", "helloo infey",
                            "hey infi", "hey infee", "hey infy", "hey infie", "hey infey",
                            "heyy infi", "heyy infee", "heyy infy", "heyy infie", "heyy infey",
                            "heya infi", "heya infee", "heya infy", "heya infie", "heya infey",
                            "yo infi", "yo infee", "yo infy", "yo infie", "yo infey",
                            "sup infi", "sup infee", "sup infy", "sup infie", "sup infey"
                            ];
                        const foundWakeWord = wakeWords.some(word => 
                            transcript.toLowerCase().includes(word)
                        );
                        
                        if (foundWakeWord) {
                            wakeWordDetected = true;
                            const messages = document.getElementById('messages');
                            const botMessage = document.createElement('div');
                            botMessage.className = 'bot-message';
                            botMessage.textContent = "Hello! How can I help you today?";
                            messages.appendChild(botMessage);
                            speakResponse("Hello! How can I help you today?");
                            conversationActive = true;
                            document.querySelector('.mic-container').classList.add('active');
                            return;
                        } else {
                            // Ignore all other input until wake word is detected
                            return;
                        }
                    }

                    // Normal conversation flow
                    const messages = document.getElementById('messages');
                    const userMessage = document.createElement('div');
                    userMessage.className = 'user-message';
                    userMessage.textContent = transcript;
                    messages.appendChild(userMessage);

                    if (["bye", "exit", "goodbye"].some(cmd => transcript.toLowerCase().includes(cmd))) {
                        handleExitCommand();
                        return;
                    }

                    axios.post('/api/gmtt/', { prompt: transcript, job: "general" })
                        .then(response => {
                            const botMessage = document.createElement('div');
                            botMessage.className = 'bot-message';
                            botMessage.textContent = response.data.text;
                            messages.appendChild(botMessage);

                            speakResponse(response.data.text);
                        })
                        .catch(error => {
                            console.error(error);
                            const botMessage = document.createElement('div');
                            botMessage.className = 'bot-message';
                            botMessage.textContent = "Something went wrong. Please try again.";
                            messages.appendChild(botMessage);
                        });
                }
            };

            recognition.onerror = function (event) {
                console.error('Speech recognition error:', event.error);
                isListening = false;
                updateMicButton();
            };

            recognition.onend = function () {
                if (isListening && conversationActive) {
                    recognition.start();
                } else {
                    updateMicButton();
                }
            };

            recognition.start();
        }

        function handleExitCommand() {
            // Requirement 5: Handle exit commands
            speakResponse("Ok bye! Have a good day!");

            // Close mic and reset
            if (isListening) {
                recognition.stop();
                isListening = false;
            }

            // Move animation to bottom
            document.querySelector('.mic-container').classList.remove('active');

            // Reset conversation state
            conversationActive = false;
            wakeWordDetected = false;

            // Update mic button
            updateMicButton();
        }

        function toggleChat() {
            const chatContainer = document.querySelector('.chat-container');
            const micContainer = document.querySelector('.mic-container');
            chatContainer.style.display = chatContainer.style.display === 'flex' ? 'none' : 'flex';
            micContainer.style.display = micContainer.style.display === 'none' ? 'flex' : 'none';
        }

        // Initialize mic on page load
        window.onload = function() {
            startVoiceRecognition();
        };
    </script>
    <script>
        function scrollToBottom() {
            const chatWindow = document.getElementById('chat-window');
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
    </script>
</body>

</html> -->


<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InFi Chatbot</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2e7d32; /* Forest green */
            --secondary-color: #1b5e20; /* Darker green */
            --accent-color: #8bc34a; /* Light green */
            --text-color: #263238; /* Dark blue-gray */
            --light-text: #f1f8e9; /* Light greenish white */
            --background: #e8f5e9; /* Very light green */
            --card-bg: #ffffff;
            --border-color: #c8e6c9; /* Light green border */
            --shadow: 0 4px 12px rgba(46, 125, 50, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--background);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            color: var(--text-color);
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 50%, #a5d6a7 100%);
        }

        .mic-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            transition: all 0.5s ease-in-out;
            z-index: 1000;
            width: 120px;
            height: 120px;
            /* border-radius: 50%; */
            /* background-color: var(--primary-color);
            box-shadow: var(--shadow); */
            /* border: 3px solid var(--accent-color); */
        }

        .mic-container.active {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 300px;
            /* border-radius: 50%;
            background-color: var(--primary-color);
            background-image: radial-gradient(circle, var(--accent-color) 0%, var(--primary-color) 70%); */
        }

        .mic-container.active #mic-btn {
            width: 280px;
            height: 280px;
            /* border-radius: 50%;
            border: 5px solid var(--accent-color); */
        }

        .mic-container.active #mic-btn img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .mic-container.active .mic-status {
            font-size: 18px;
            margin-top: 15px;
            color: var(--light-text);
            font-weight: 500;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        #mic-btn {
            background: none;
            border: none;
            cursor: pointer;
            outline: none;
            padding: 0;
            width: 100px;
            height: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease-in-out;
            border-radius: 50%;
            background-color: var(--primary-color);
            border: 3px solid var(--accent-color);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        #mic-btn img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .mic-status {
            margin-top: 10px;
            font-size: 16px;
            color: var(--light-text);
            text-align: center;
            display: none;
            font-weight: 500;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .mic-container.active .mic-status {
            display: block;
        }

        .chat-container {
            display: none;
            flex-direction: column;
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
            background: var(--card-bg);
            padding: 24px;
            border-radius: 12px;
            height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            transition: all 0.3s ease-in-out;
            background-image: linear-gradient(to bottom, rgba(255,255,255,0.9), rgba(233,245,233,0.9));
            position: relative;
        }

        .chat-container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 10px;
            background: linear-gradient(to right, 
                #8bc34a, #7cb342, #689f38, #558b2f, #2e7d32);
            border-radius: 12px 12px 0 0;
        }

        .chat-container h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 24px;
            font-size: 24px;
            font-weight: 600;
            position: relative;
            padding-bottom: 10px;
        }

        .chat-container h1::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 25%;
            right: 25%;
            height: 2px;
            background: linear-gradient(to right, transparent, var(--accent-color), transparent);
        }

        #chat-window {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 8px;
            background-color: rgba(255,255,255,0.7);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        #messages {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .user-message {
            background: var(--primary-color);
            align-self: flex-end;
            color: var(--light-text);
            text-align: right;
            border-radius: 12px 12px 0 12px;
            box-shadow: var(--shadow);
            border: none;
            position: relative;
        }

        .user-message::after {
            content: "";
            position: absolute;
            bottom: 0;
            right: -10px;
            width: 0;
            height: 0;
            border: 10px solid transparent;
            border-left-color: var(--primary-color);
            border-right: 0;
            margin-top: -10px;
            margin-right: -10px;
        }

        .bot-message {
            background: var(--card-bg);
            align-self: flex-start;
            color: var(--text-color);
            text-align: left;
            border-radius: 12px 12px 12px 0;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            position: relative;
        }

        .bot-message::before {
            content: "";
            position: absolute;
            bottom: 0;
            left: -10px;
            width: 0;
            height: 0;
            border: 10px solid transparent;
            border-right-color: var(--card-bg);
            border-left: 0;
            margin-top: -10px;
            margin-left: -10px;
        }

        #messages>div {
            padding: 12px 16px;
            max-width: 75%;
            line-height: 1.5;
            word-wrap: break-word;
            font-size: 15px;
        }

        form {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }

        input#prompt {
            flex: 1;
            padding: 12px 16px;
            font-size: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--card-bg);
            color: var(--text-color);
            outline: none;
            transition: all 0.3s;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%232e7d32" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 1 0 10 10 4 4 0 0 1-5 3.9 4 4 0 0 1-1-7.8V6a2 2 0 0 1 2-2z"></path></svg>');
            background-repeat: no-repeat;
            background-position: 12px center;
            padding-left: 40px;
        }

        input#prompt:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(46, 125, 50, 0.2);
        }

        form button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        form button:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        #toggle-chat-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--primary-color);
            border: none;
            cursor: pointer;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            z-index: 1001;
            transition: all 0.3s;
            border: 2px solid var(--accent-color);
        }

        #toggle-chat-btn:hover {
            background-color: var(--secondary-color);
            transform: scale(1.05);
        }

        #menu-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--primary-color);
            border: none;
            cursor: pointer;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            z-index: 1001;
            transition: all 0.3s;
            border: 2px solid var(--accent-color);
        }

        #menu-btn:hover {
            background-color: var(--secondary-color);
            transform: scale(1.05);
        }

        @media (max-width: 768px) {
            .mic-container {
                bottom: 10px;
                width: 100px;
                height: 100px;
            }

            .mic-container.active {
                width: 250px;
                height: 250px;
            }

            .mic-container.active #mic-btn {
                width: 230px;
                height: 230px;
            }

            #mic-btn {
                width: 80px;
                height: 80px;
            }

            #toggle-chat-btn,
            #menu-btn {
                top: 20px;
                bottom: auto;
            }

            #toggle-chat-btn {
                right: 20px;
            }

            #menu-btn {
                left: 20px;
            }

            .chat-container {
                height: 90vh;
                border-radius: 0;
                padding: 16px;
            }
        }

        /* Typing indicators */
        .typing-indicator {
            color: #689f38;
            font-style: italic;
            font-size: 14px;
            padding: 8px 16px;
            position: relative;
        }

        .typing-indicator::before {
            content: "üå±";
            margin-right: 5px;
        }

        .user-typing {
            align-self: flex-end;
        }

        .bot-typing {
            align-self: flex-start;
        }

        /* Leaf decoration for messages */
        .user-message::before {
            content: "üçÉ";
            position: absolute;
            left: -25px;
            top: 50%;
            transform: translateY(-50%);
        }

        .bot-message::after {
            content: "üåø";
            position: absolute;
            right: -25px;
            top: 50%;
            transform: translateY(-50%);
        }
    </style>
</head>

<body>
    <button id="menu-btn">
        <i class="fas fa-leaf"></i>
    </button>
    <button id="toggle-chat-btn" onclick="toggleChat()">
        <i class="fas fa-keyboard"></i>
    </button>
    <div class="mic-container">
        <button id="mic-btn" onclick="handleMicClick()">
            <img src="/static/assets/voicegif.gif" alt="Voice GIF">
        </button>
        <div class="mic-status"></div>
    </div>
    <div class="chat-container">
        <h1>Give me trees</h1>
        <div id="chat-window">
            <div id="messages"></div>
        </div>
        <form onsubmit="event.preventDefault(); sendMessage();">
            <input type="text" id="prompt" placeholder="Type your message here..." />
            <button type="submit">
                <i class="fas fa-paper-plane"></i>
            </button>
        </form>
    </div>

    <script>
        let recognition;
        let isListening = false;
        let isBotSpeaking = false;
        let isFirstClick = true;
        let selectedVoice = null;
        let conversationActive = false;
        let wakeWordDetected = false;

        function loadVoices() {
            const voices = window.speechSynthesis.getVoices();
            selectedVoice = voices.find(voice => voice.name.toLowerCase().includes('neerja'));

            if (!selectedVoice) {
                console.warn("Neerja voice not found. Using default voice.");
            }
        }

        if (window.speechSynthesis.getVoices().length > 0) {
            loadVoices();
        } else {
            window.speechSynthesis.onvoiceschanged = loadVoices;
        }

        function sendMessage() {
            const prompt = document.getElementById('prompt').value;
            const messages = document.getElementById('messages');
            if (!prompt.trim()) return;

            const userMessage = document.createElement('div');
            userMessage.className = 'user-message';
            userMessage.textContent = prompt;
            messages.appendChild(userMessage);
            scrollToBottom(); // Auto-scroll after adding user message

            const userTypingIndicator = document.createElement('div');
            userTypingIndicator.className = 'typing-indicator user-typing';
            userTypingIndicator.textContent = 'You are typing...';
            messages.appendChild(userTypingIndicator);
            scrollToBottom(); // Auto-scroll after adding typing indicator

            document.getElementById('prompt').value = '';

            axios.post('/api/gmtt/', { prompt: prompt, job: "general" })
                .then(response => {
                    messages.removeChild(userTypingIndicator);

                    const botTypingIndicator = document.createElement('div');
                    botTypingIndicator.className = 'typing-indicator bot-typing';
                    botTypingIndicator.textContent = 'Bot is typing...';
                    messages.appendChild(botTypingIndicator);
                    scrollToBottom(); // Auto-scroll after adding bot typing indicator

                    setTimeout(() => {
                        messages.removeChild(botTypingIndicator);

                        const botMessage = document.createElement('div');
                        botMessage.className = 'bot-message';
                        botMessage.textContent = response.data.text;
                        messages.appendChild(botMessage);
                        scrollToBottom(); // Auto-scroll after adding bot message

                        if (["bye", "exit", "goodbye"].includes(prompt.toLowerCase())) {
                            handleExitCommand();
                        } else {
                            speakResponse(response.data.text);
                        }
                    }, 1000);
                })
                .catch(error => {
                    console.error(error);
                    messages.removeChild(userTypingIndicator);

                    const botMessage = document.createElement('div');
                    botMessage.className = 'bot-message';
                    botMessage.textContent = "Something went wrong. Please try again.";
                    messages.appendChild(botMessage);
                    scrollToBottom(); // Auto-scroll after error message
                });
        }

        function speakResponse(text) {
            window.speechSynthesis.cancel();

            if (isListening) {
                recognition.stop();
                isListening = false;
                updateMicButton();
            }

            const speech = new SpeechSynthesisUtterance(text);
            speech.lang = 'en-IN';

            if (selectedVoice) {
                speech.voice = selectedVoice;
            }

            speech.onstart = () => {
                isBotSpeaking = true;
                document.getElementById('mic-btn').innerHTML = '<img src="/static/assets/voicegif.gif" alt="Voice Active GIF">';
            };

            speech.onend = () => {
                isBotSpeaking = false;
                if (conversationActive && !isListening) {
                    // Add a small delay before restarting recognition
                    setTimeout(() => {
                        try {
                            if (!isListening) {
                                recognition.start();
                                isListening = true;
                                document.getElementById('mic-btn').innerHTML = '<img src="/static/assets/voicegif.gif" alt="Voice GIF">';
                            }
                        } catch (e) {
                            console.log("Recognition start error:", e);
                            // If start fails, try again after a short delay
                            setTimeout(() => {
                                if (!isListening) {
                                    recognition.start();
                                    isListening = true;
                                    document.getElementById('mic-btn').innerHTML = '<img src="/static/assets/voicegif.gif" alt="Voice GIF">';
                                }
                            }, 500);
                        }
                    }, 500);
                }
            };

            window.speechSynthesis.speak(speech);
        }

        function updateMicButton() {
            const micBtn = document.getElementById('mic-btn');
            if (isBotSpeaking) {
                micBtn.innerHTML = '<img src="/static/assets/voicegif.gif" alt="Voice Active GIF">';
            } else {
                micBtn.innerHTML = isListening
                    ? '<img src="/static/assets/voicegif.gif" alt="Voice GIF">'
                    : '<img src="/static/assets/voicegif.gif" alt="Voice Inactive GIF">';
            }
        }

        function handleMicClick() {
            const micContainer = document.querySelector('.mic-container');
            const micStatus = document.querySelector('.mic-status');

            if (!conversationActive) {
                // First interaction - start conversation
                micContainer.classList.add('active');
                startVoiceRecognition(true);
                conversationActive = true;
                wakeWordDetected = true; // Consider click as wake word
                return;
            }

            if (isBotSpeaking) {
                // Requirement 3: Click while bot is speaking
                window.speechSynthesis.cancel();
                isBotSpeaking = false;
                startVoiceRecognition();
            } else {
                // Toggle between bottom and center positions
                if (micContainer.classList.contains('active')) {
                    // Currently in center - move to bottom
                    micContainer.classList.remove('active');
                    if (isListening) {
                        recognition.stop();
                        isListening = false;
                    }
                } else {
                    // Currently in bottom - move to center and restart
                    micContainer.classList.add('active');
                    startVoiceRecognition();
                }
            }
        }

        function startVoiceRecognition(initialStart = false) {
            if (!('webkitSpeechRecognition' in window)) {
                alert('Speech recognition is not supported in this browser.');
                return;
            }

            if (isListening && !initialStart) {
                recognition.stop();
                isListening = false;
                updateMicButton();
                return;
            }

            // If recognition already exists and is running, stop it first
            if (recognition && isListening) {
                recognition.stop();
                isListening = false;
            }

            recognition = new webkitSpeechRecognition();
            recognition.lang = 'en-IN';
            recognition.interimResults = false;
            recognition.continuous = true;

            recognition.onstart = function () {
                isListening = true;
                document.getElementById('mic-btn').innerHTML = '<img src="/static/assets/voicegif.gif" alt="Voice Active GIF">';
                document.querySelector('.mic-status').textContent = 'Listening...';
                
                if (!wakeWordDetected && !initialStart) {
                    document.querySelector('.mic-status').textContent = 'Hello! I am Infi';
                }
            };

            recognition.onresult = function (event) {
                const transcript = event.results[event.results.length - 1][0].transcript.trim();
                if (transcript) {
                    // Check for wake word if conversation hasn't started yet
                    if (!wakeWordDetected) {
                        const wakeWords = [
                            "hi infi", "hi infee", "hi infy", "hi infie", "hi infey",
                            "hii infi", "hii infee", "hii infy", "hii infie", "hii infey",
                            "hello infi", "hello infee", "hello infy", "hello infie", "hello infey",
                            "helloo infi", "helloo infee", "helloo infy", "helloo infie", "helloo infey",
                            "hey infi", "hey infee", "hey infy", "hey infie", "hey infey",
                            "heyy infi", "heyy infee", "heyy infy", "heyy infie", "heyy infey",
                            "heya infi", "heya infee", "heya infy", "heya infie", "heya infey",
                            "yo infi", "yo infee", "yo infy", "yo infie", "yo infey",
                            "sup infi", "sup infee", "sup infy", "sup infie", "sup infey"
                            ];
                        const foundWakeWord = wakeWords.some(word => 
                            transcript.toLowerCase().includes(word)
                        );
                        
                        if (foundWakeWord) {
                            wakeWordDetected = true;
                            const messages = document.getElementById('messages');
                            const botMessage = document.createElement('div');
                            botMessage.className = 'bot-message';
                            botMessage.textContent = "Hello! How can I help you today?";
                            messages.appendChild(botMessage);
                            speakResponse("Hello! How can I help you today?");
                            conversationActive = true;
                            document.querySelector('.mic-container').classList.add('active');
                            return;
                        } else {
                            // Ignore all other input until wake word is detected
                            return;
                        }
                    }

                    // Normal conversation flow
                    const messages = document.getElementById('messages');
                    const userMessage = document.createElement('div');
                    userMessage.className = 'user-message';
                    userMessage.textContent = transcript;
                    messages.appendChild(userMessage);

                    if (["bye", "exit", "goodbye"].some(cmd => transcript.toLowerCase().includes(cmd))) {
                        handleExitCommand();
                        return;
                    }

                    axios.post('/api/gmtt/', { prompt: transcript, job: "general" })
                        .then(response => {
                            const botMessage = document.createElement('div');
                            botMessage.className = 'bot-message';
                            botMessage.textContent = response.data.text;
                            messages.appendChild(botMessage);

                            speakResponse(response.data.text);
                        })
                        .catch(error => {
                            console.error(error);
                            const botMessage = document.createElement('div');
                            botMessage.className = 'bot-message';
                            botMessage.textContent = "Something went wrong. Please try again.";
                            messages.appendChild(botMessage);
                        });
                }
            };

            recognition.onerror = function (event) {
                console.error('Speech recognition error:', event.error);
                isListening = false;
                updateMicButton();
            };

            recognition.onend = function () {
                if (isListening && conversationActive) {
                    recognition.start();
                } else {
                    updateMicButton();
                }
            };

            recognition.start();
        }

        function handleExitCommand() {
            // Requirement 5: Handle exit commands
            speakResponse("Ok bye! Have a good day!");

            // Close mic and reset
            if (isListening) {
                recognition.stop();
                isListening = false;
            }

            // Move animation to bottom
            document.querySelector('.mic-container').classList.remove('active');

            // Reset conversation state
            conversationActive = false;
            wakeWordDetected = false;

            // Update mic button
            updateMicButton();
        }

        function toggleChat() {
            const chatContainer = document.querySelector('.chat-container');
            const micContainer = document.querySelector('.mic-container');
            chatContainer.style.display = chatContainer.style.display === 'flex' ? 'none' : 'flex';
            micContainer.style.display = micContainer.style.display === 'none' ? 'flex' : 'none';
        }

        // Initialize mic on page load
        window.onload = function() {
            startVoiceRecognition();
        };
    </script>
    <script>
        function scrollToBottom() {
            const chatWindow = document.getElementById('chat-window');
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
    </script>
</body>

</html>


<!-- <!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TreeBot - Give Me Trees Foundation</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2e7d32; /* Forest green */
            --secondary-color: #1b5e20; /* Darker green */
            --accent-color: #8bc34a; /* Light green */
            --text-color: #263238; /* Dark blue-gray */
            --light-text: #f1f8e9; /* Light greenish white */
            --background: rgba(232, 245, 233, 0.9); /* Very light green with transparency */
            --card-bg: rgba(255, 255, 255, 0.95);
            --border-color: #c8e6c9; /* Light green border */
            --shadow: 0 4px 12px rgba(46, 125, 50, 0.2);
        }

        body {
            font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            color: var(--text-color);
            background: url('https://images.unsplash.com/photo-1465146344425-f00d5f5c8f07?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80') no-repeat center center fixed;
            background-size: cover;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Voice Interface Styles */
        .voice-interface {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .voice-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: radial-gradient(circle, var(--accent-color), var(--primary-color));
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: var(--shadow);
            border: 3px solid white;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .voice-circle.active {
            width: 250px;
            height: 250px;
            box-shadow: 0 0 30px rgba(139, 195, 74, 0.6);
        }

        .voice-circle::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path fill="white" d="M50 20c-8.3 0-15 6.7-15 15v20c0 8.3 6.7 15 15 15s15-6.7 15-15V35c0-8.3-6.7-15-15-15zm22.5 15c0-12.4-10.1-22.5-22.5-22.5S27.5 22.6 27.5 35v20c0 12.4 10.1 22.5 22.5 22.5s22.5-10.1 22.5-22.5V35zM50 65c-5.5 0-10-4.5-10-10h-5c0 8.3 6.7 15 15 15v-5zm20-20h5v10h-5V45zm-40 0h5v10h-5V45z"/></svg>') no-repeat center center;
            background-size: 50%;
            opacity: 0.8;
            transition: all 0.3s ease;
        }

        .voice-circle.active::before {
            background-size: 40%;
            opacity: 0.6;
        }

        .voice-circle.listening::before {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.6; }
            50% { transform: scale(1.1); opacity: 0.9; }
            100% { transform: scale(1); opacity: 0.6; }
        }

        .voice-status {
            margin-top: 15px;
            padding: 8px 16px;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: var(--shadow);
            font-size: 16px;
            font-weight: 500;
            color: var(--primary-color);
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            max-width: 80vw;
            text-align: center;
        }

        .voice-status.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Chat Container Styles */
        .chat-container {
            display: none;
            flex-direction: column;
            width: 90%;
            max-width: 500px;
            max-height: 70vh;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: var(--shadow);
            overflow: hidden;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1001;
            border: 1px solid var(--border-color);
        }

        .chat-header {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h2 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .chat-header .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }

        #chat-window {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: var(--background);
        }

        #messages {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.4;
            position: relative;
            word-wrap: break-word;
        }

        .user-message {
            align-self: flex-end;
            background: var(--primary-color);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .bot-message {
            align-self: flex-start;
            background: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-bottom-left-radius: 4px;
        }

        .chat-input-container {
            display: flex;
            padding: 10px 15px;
            background: white;
            border-top: 1px solid var(--border-color);
        }

        #prompt {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            outline: none;
            font-size: 15px;
        }

        #prompt:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(139, 195, 74, 0.3);
        }

        .send-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            margin-left: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .send-btn:hover {
            background: var(--secondary-color);
            transform: scale(1.05);
        }

        /* Control Buttons */
        .control-btn {
            position: fixed;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: var(--shadow);
            z-index: 1002;
            transition: all 0.2s;
        }

        .control-btn:hover {
            background: var(--secondary-color);
            transform: scale(1.1);
        }

        #toggle-chat-btn {
            bottom: 100px;
            right: 20px;
        }

        #help-btn {
            bottom: 160px;
            right: 20px;
        }

        /* Typing Indicators */
        .typing-indicator {
            display: inline-flex;
            align-items: center;
            padding: 8px 12px;
            border-radius: 18px;
            background: rgba(139, 195, 74, 0.1);
            color: var(--primary-color);
            font-size: 14px;
            margin: 5px 0;
        }

        .typing-dots {
            display: inline-flex;
            margin-left: 5px;
        }

        .typing-dots span {
            width: 6px;
            height: 6px;
            background: var(--primary-color);
            border-radius: 50%;
            margin: 0 2px;
            animation: bounce 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(1) { animation-delay: 0s; }
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }

        /* Responsive Design */
        @media (max-width: 600px) {
            .voice-circle {
                width: 100px;
                height: 100px;
            }
            
            .voice-circle.active {
                width: 200px;
                height: 200px;
            }
            
            .chat-container {
                width: 95%;
                max-height: 80vh;
            }
        }
    </style>
</head>

<body>
   
    <div class="voice-interface">
        <div class="voice-circle" id="voice-btn">
            <div class="voice-status" id="voice-status">Listening...</div>
        </div>
    </div>

    
    <div class="chat-container" id="chat-container">
        <div class="chat-header">
            <h2>TreeBot - Give Me Trees Foundation</h2>
            <button class="close-btn" id="close-chat-btn">&times;</button>
        </div>
        <div id="chat-window">
            <div id="messages"></div>
        </div>
        <div class="chat-input-container">
            <input type="text" id="prompt" placeholder="Type your message...">
            <button class="send-btn" id="send-btn">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

   
    <button class="control-btn" id="toggle-chat-btn">
        <i class="fas fa-comment-alt"></i>
    </button>
    <button class="control-btn" id="help-btn">
        <i class="fas fa-question"></i>
    </button>

    <script>
        // DOM Elements
        const voiceBtn = document.getElementById('voice-btn');
        const voiceStatus = document.getElementById('voice-status');
        const chatContainer = document.getElementById('chat-container');
        const toggleChatBtn = document.getElementById('toggle-chat-btn');
        const closeChatBtn = document.getElementById('close-chat-btn');
        const sendBtn = document.getElementById('send-btn');
        const promptInput = document.getElementById('prompt');
        const messagesContainer = document.getElementById('messages');
        const helpBtn = document.getElementById('help-btn');

        // State variables
        let recognition;
        let isListening = false;
        let isBotSpeaking = false;
        let conversationActive = false;
        let wakeWordDetected = false;

        // Initialize voice recognition
        function initVoiceRecognition() {
            if (!('webkitSpeechRecognition' in window)) {
                voiceStatus.textContent = "Voice not supported in your browser";
                voiceStatus.classList.add('show');
                setTimeout(() => voiceStatus.classList.remove('show'), 3000);
                return;
            }

            recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = false;
            recognition.lang = 'en-IN';

            recognition.onstart = () => {
                isListening = true;
                voiceBtn.classList.add('listening');
                updateVoiceStatus("Listening...");
            };

            recognition.onresult = (event) => {
                const transcript = event.results[event.results.length - 1][0].transcript.trim();
                if (!transcript) return;

                if (!wakeWordDetected) {
                    if (transcript.toLowerCase().includes("treebot") || 
                        transcript.toLowerCase().includes("hey tree") || 
                        transcript.toLowerCase().includes("hi tree")) {
                        wakeWordDetected = true;
                        addBotMessage("Hello! I'm TreeBot from Give Me Trees Foundation. How can I help you today?");
                        speakResponse("Hello! I'm TreeBot from Give Me Trees Foundation. How can I help you today?");
                        return;
                    }
                    updateVoiceStatus("Say 'Hey TreeBot' to start");
                    return;
                }

                addUserMessage(transcript);
                
                if (["exit", "quit", "goodbye", "bye"].some(word => 
                    transcript.toLowerCase().includes(word))) {
                    handleExitCommand();
                    return;
                }

                processUserInput(transcript);
            };

            recognition.onerror = (event) => {
                console.error('Recognition error:', event.error);
                isListening = false;
                voiceBtn.classList.remove('listening');
                updateVoiceStatus("Error occurred. Try again.");
            };

            recognition.onend = () => {
                isListening = false;
                voiceBtn.classList.remove('listening');
                if (conversationActive && !isBotSpeaking) {
                    setTimeout(() => recognition.start(), 500);
                }
            };
        }

        // Voice control functions
        function startListening() {
            if (!recognition) initVoiceRecognition();
            try {
                recognition.start();
                conversationActive = true;
                voiceBtn.classList.add('active');
            } catch (e) {
                console.error("Recognition start error:", e);
            }
        }

        function stopListening() {
            if (recognition && isListening) {
                recognition.stop();
            }
            voiceBtn.classList.remove('active');
        }

        function toggleListening() {
            if (isListening) {
                stopListening();
            } else {
                startListening();
            }
        }

        function updateVoiceStatus(text) {
            voiceStatus.textContent = text;
            voiceStatus.classList.add('show');
            setTimeout(() => voiceStatus.classList.remove('show'), 3000);
        }

        // Chat functions
        function addMessage(text, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            messageDiv.textContent = text;
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        function addUserMessage(text) {
            addMessage(text, true);
        }

        function addBotMessage(text) {
            addMessage(text, false);
        }

        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.innerHTML = `
                <span>TreeBot is typing</span>
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            `;
            messagesContainer.appendChild(typingDiv);
            scrollToBottom();
            return typingDiv;
        }

        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Speech synthesis
        function speakResponse(text) {
            if (isBotSpeaking) window.speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 1;
            utterance.pitch = 1;
            utterance.volume = 1;
            
            utterance.onstart = () => {
                isBotSpeaking = true;
                voiceBtn.classList.add('listening');
            };
            
            utterance.onend = () => {
                isBotSpeaking = false;
                voiceBtn.classList.remove('listening');
                if (conversationActive) {
                    setTimeout(() => recognition.start(), 500);
                }
            };
            
            window.speechSynthesis.speak(utterance);
        }

        // Message processing
        function processUserInput(input) {
            const typingIndicator = showTypingIndicator();
            
            axios.post('/api/gmtt/', { prompt: input })
                .then(response => {
                    messagesContainer.removeChild(typingIndicator);
                    addBotMessage(response.data.text);
                    speakResponse(response.data.text);
                })
                .catch(error => {
                    console.error(error);
                    messagesContainer.removeChild(typingIndicator);
                    addBotMessage("Sorry, I encountered an error. Please try again.");
                });
        }

        function handleExitCommand() {
            addBotMessage("Goodbye! Thank you for supporting Give Me Trees Foundation.");
            speakResponse("Goodbye! Thank you for supporting Give Me Trees Foundation.");
            stopListening();
            conversationActive = false;
            wakeWordDetected = false;
            voiceBtn.classList.remove('active');
        }

        // Event listeners
        voiceBtn.addEventListener('click', toggleListening);
        
        toggleChatBtn.addEventListener('click', () => {
            chatContainer.style.display = chatContainer.style.display === 'flex' ? 'none' : 'flex';
        });
        
        closeChatBtn.addEventListener('click', () => {
            chatContainer.style.display = 'none';
        });
        
        sendBtn.addEventListener('click', () => {
            const message = promptInput.value.trim();
            if (message) {
                addUserMessage(message);
                promptInput.value = '';
                processUserInput(message);
            }
        });
        
        promptInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendBtn.click();
            }
        });
        
        helpBtn.addEventListener('click', () => {
            addBotMessage("I'm TreeBot from Give Me Trees Foundation. You can ask me about tree planting, our initiatives, or how to get involved. Try saying 'Hey TreeBot' to start a voice conversation!");
        });

        // Initialize
        initVoiceRecognition();
    </script>
</body>

</html> -->