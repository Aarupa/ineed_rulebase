<!-- <!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InFi Chatbot</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #1890ff;
            --secondary-color: #096dd9;
            --accent-color: #13c2c2;
            --text-color: #333;
            --light-text: #f0f0f0;
            --background: #f5f5f5;
            --card-bg: #ffffff;
            --border-color: #d9d9d9;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--background);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            color: var(--text-color);
        }

        .mic-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            transition: all 0.5s ease-in-out;
            z-index: 1000;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background-color: var(--primary-color);
            box-shadow: var(--shadow);
        }

        .mic-container.active {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 300px;
            border-radius: 50%;
            background-color: var(--primary-color);
        }

        .mic-container.active #mic-btn {
            width: 280px;
            height: 280px;
            border-radius: 50%;
        }

        .mic-container.active #mic-btn img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .mic-container.active .mic-status {
            font-size: 18px;
            margin-top: 15px;
            color: var(--light-text);
            font-weight: 500;
        }

        #mic-btn {
            background: none;
            border: none;
            cursor: pointer;
            outline: none;
            padding: 0;
            width: 100px;
            height: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease-in-out;
            border-radius: 50%;
            background-color: var(--primary-color);
        }

        #mic-btn img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .mic-status {
            margin-top: 10px;
            font-size: 16px;
            color: var(--light-text);
            text-align: center;
            display: none;
            font-weight: 500;
        }

        .mic-container.active .mic-status {
            display: block;
        }

        .chat-container {
            display: none;
            flex-direction: column;
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
            background: var(--card-bg);
            padding: 24px;
            border-radius: 12px;
            height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            transition: all 0.3s ease-in-out;
        }

        .chat-container h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 24px;
            font-size: 24px;
            font-weight: 600;
        }

        #chat-window {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 8px;
        }

        #messages {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .user-message {
            background: var(--primary-color);
            align-self: flex-end;
            color: var(--light-text);
            text-align: right;
            border-radius: 12px 12px 0 12px;
            box-shadow: var(--shadow);
            border: none;
        }

        .bot-message {
            background: var(--card-bg);
            align-self: flex-start;
            color: var(--text-color);
            text-align: left;
            border-radius: 12px 12px 12px 0;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        #messages>div {
            padding: 12px 16px;
            max-width: 75%;
            line-height: 1.5;
            word-wrap: break-word;
            font-size: 15px;
        }

        form {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }

        input#prompt {
            flex: 1;
            padding: 12px 16px;
            font-size: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--card-bg);
            color: var(--text-color);
            outline: none;
            transition: all 0.3s;
        }

        input#prompt:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
        }

        form button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        form button:hover {
            background-color: var(--secondary-color);
        }

        #toggle-chat-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--primary-color);
            border: none;
            cursor: pointer;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            z-index: 1001;
            transition: all 0.3s;
        }

        #toggle-chat-btn:hover {
            background-color: var(--secondary-color);
            transform: scale(1.05);
        }

        #menu-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--primary-color);
            border: none;
            cursor: pointer;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            z-index: 1001;
            transition: all 0.3s;
        }

        #menu-btn:hover {
            background-color: var(--secondary-color);
            transform: scale(1.05);
        }

        @media (max-width: 768px) {
            .mic-container {
                bottom: 10px;
                width: 100px;
                height: 100px;
            }

            .mic-container.active {
                width: 250px;
                height: 250px;
            }

            .mic-container.active #mic-btn {
                width: 230px;
                height: 230px;
            }

            #mic-btn {
                width: 80px;
                height: 80px;
            }

            #toggle-chat-btn,
            #menu-btn {
                top: 20px;
                bottom: auto;
            }

            #toggle-chat-btn {
                right: 20px;
            }

            #menu-btn {
                left: 20px;
            }

            .chat-container {
                height: 90vh;
                border-radius: 0;
                padding: 16px;
            }
        }

        /* Typing indicators */
        .typing-indicator {
            color: #999;
            font-style: italic;
            font-size: 14px;
            padding: 8px 16px;
        }

        .user-typing {
            align-self: flex-end;
        }

        .bot-typing {
            align-self: flex-start;
        }
    </style>
</head>

<body>
    <button id="menu-btn">
        <i class="fas fa-bars"></i>
    </button>
    <button id="toggle-chat-btn" onclick="toggleChat()">
        <i class="fas fa-keyboard"></i>
    </button>
    <div class="mic-container">
        <button id="mic-btn" onclick="handleMicClick()">
            <img src="/static/assets/voicegif.gif" alt="Voice GIF">
        </button>
        <div class="mic-status"></div>
    </div>
    <div class="chat-container">
        <h1>InFi Chatbot</h1>
        <div id="chat-window">
            <div id="messages"></div>
        </div>
        <form onsubmit="event.preventDefault(); sendMessage();">
            <input type="text" id="prompt" placeholder="Type your message here..." />
            <button type="submit">
                <i class="fas fa-paper-plane"></i>
            </button>
        </form>
    </div>

    <script>
        let recognition;
        let isListening = false;
        let isBotSpeaking = false;
        let isFirstClick = true;
        let selectedVoice = null;
        let conversationActive = false;
        let wakeWordDetected = false;

        function loadVoices() {
            const voices = window.speechSynthesis.getVoices();
            selectedVoice = voices.find(voice => voice.name.toLowerCase().includes('neerja'));

            if (!selectedVoice) {
                console.warn("Neerja voice not found. Using default voice.");
            }
        }

        if (window.speechSynthesis.getVoices().length > 0) {
            loadVoices();
        } else {
            window.speechSynthesis.onvoiceschanged = loadVoices;
        }

        function sendMessage() {
            const prompt = document.getElementById('prompt').value;
            const messages = document.getElementById('messages');
            if (!prompt.trim()) return;

            const userMessage = document.createElement('div');
            userMessage.className = 'user-message';
            userMessage.textContent = prompt;
            messages.appendChild(userMessage);
            scrollToBottom(); // Auto-scroll after adding user message

            const userTypingIndicator = document.createElement('div');
            userTypingIndicator.className = 'typing-indicator user-typing';
            userTypingIndicator.textContent = 'You are typing...';
            messages.appendChild(userTypingIndicator);
            scrollToBottom(); // Auto-scroll after adding typing indicator

            document.getElementById('prompt').value = '';

            axios.post('/api/gmtt/', { prompt: prompt, job: "general" })
                .then(response => {
                    messages.removeChild(userTypingIndicator);

                    const botTypingIndicator = document.createElement('div');
                    botTypingIndicator.className = 'typing-indicator bot-typing';
                    botTypingIndicator.textContent = 'Bot is typing...';
                    messages.appendChild(botTypingIndicator);
                    scrollToBottom(); // Auto-scroll after adding bot typing indicator

                    setTimeout(() => {
                        messages.removeChild(botTypingIndicator);

                        const botMessage = document.createElement('div');
                        botMessage.className = 'bot-message';
                        botMessage.textContent = response.data.text;
                        messages.appendChild(botMessage);
                        scrollToBottom(); // Auto-scroll after adding bot message

                        if (["bye", "exit", "goodbye"].includes(prompt.toLowerCase())) {
                            handleExitCommand();
                        } else {
                            speakResponse(response.data.text);
                        }
                    }, 1000);
                })
                .catch(error => {
                    console.error(error);
                    messages.removeChild(userTypingIndicator);

                    const botMessage = document.createElement('div');
                    botMessage.className = 'bot-message';
                    botMessage.textContent = "Something went wrong. Please try again.";
                    messages.appendChild(botMessage);
                    scrollToBottom(); // Auto-scroll after error message
                });
        }

        function speakResponse(text) {
            window.speechSynthesis.cancel();

            if (isListening) {
                recognition.stop();
                isListening = false;
                updateMicButton();
            }

            const speech = new SpeechSynthesisUtterance(text);
            speech.lang = 'en-IN';

            if (selectedVoice) {
                speech.voice = selectedVoice;
            }

            speech.onstart = () => {
                isBotSpeaking = true;
                document.getElementById('mic-btn').innerHTML = '<img src="/static/assets/voicegif.gif" alt="Voice Active GIF">';
            };

            speech.onend = () => {
                isBotSpeaking = false;
                if (conversationActive && !isListening) {
                    // Add a small delay before restarting recognition
                    setTimeout(() => {
                        try {
                            if (!isListening) {
                                recognition.start();
                                isListening = true;
                                document.getElementById('mic-btn').innerHTML = '<img src="/static/assets/voicegif.gif" alt="Voice GIF">';
                            }
                        } catch (e) {
                            console.log("Recognition start error:", e);
                            // If start fails, try again after a short delay
                            setTimeout(() => {
                                if (!isListening) {
                                    recognition.start();
                                    isListening = true;
                                    document.getElementById('mic-btn').innerHTML = '<img src="/static/assets/voicegif.gif" alt="Voice GIF">';
                                }
                            }, 500);
                        }
                    }, 500);
                }
            };

            window.speechSynthesis.speak(speech);
        }

        function updateMicButton() {
            const micBtn = document.getElementById('mic-btn');
            if (isBotSpeaking) {
                micBtn.innerHTML = '<img src="/static/assets/voicegif.gif" alt="Voice Active GIF">';
            } else {
                micBtn.innerHTML = isListening
                    ? '<img src="/static/assets/voicegif.gif" alt="Voice GIF">'
                    : '<img src="/static/assets/voicegif.gif" alt="Voice Inactive GIF">';
            }
        }

        function handleMicClick() {
            const micContainer = document.querySelector('.mic-container');
            const micStatus = document.querySelector('.mic-status');

            if (!conversationActive) {
                // First interaction - start conversation
                micContainer.classList.add('active');
                startVoiceRecognition(true);
                conversationActive = true;
                wakeWordDetected = true; // Consider click as wake word
                return;
            }

            if (isBotSpeaking) {
                // Requirement 3: Click while bot is speaking
                window.speechSynthesis.cancel();
                isBotSpeaking = false;
                startVoiceRecognition();
            } else {
                // Toggle between bottom and center positions
                if (micContainer.classList.contains('active')) {
                    // Currently in center - move to bottom
                    micContainer.classList.remove('active');
                    if (isListening) {
                        recognition.stop();
                        isListening = false;
                    }
                } else {
                    // Currently in bottom - move to center and restart
                    micContainer.classList.add('active');
                    startVoiceRecognition();
                }
            }
        }

        function startVoiceRecognition(initialStart = false) {
            if (!('webkitSpeechRecognition' in window)) {
                alert('Speech recognition is not supported in this browser.');
                return;
            }

            if (isListening && !initialStart) {
                recognition.stop();
                isListening = false;
                updateMicButton();
                return;
            }

            // If recognition already exists and is running, stop it first
            if (recognition && isListening) {
                recognition.stop();
                isListening = false;
            }

            recognition = new webkitSpeechRecognition();
            recognition.lang = 'en-IN';
            recognition.interimResults = false;
            recognition.continuous = true;

            recognition.onstart = function () {
                isListening = true;
                document.getElementById('mic-btn').innerHTML = '<img src="/static/assets/voicegif.gif" alt="Voice Active GIF">';
                document.querySelector('.mic-status').textContent = 'Listening...';
                
                if (!wakeWordDetected && !initialStart) {
                    document.querySelector('.mic-status').textContent = 'Hello! I am Infi';
                }
            };

            recognition.onresult = function (event) {
                const transcript = event.results[event.results.length - 1][0].transcript.trim();
                if (transcript) {
                    // Check for wake word if conversation hasn't started yet
                    if (!wakeWordDetected) {
                        const wakeWords = [
                            "hi infi", "hi infee", "hi infy", "hi infie", "hi infey",
                            "hii infi", "hii infee", "hii infy", "hii infie", "hii infey",
                            "hello infi", "hello infee", "hello infy", "hello infie", "hello infey",
                            "helloo infi", "helloo infee", "helloo infy", "helloo infie", "helloo infey",
                            "hey infi", "hey infee", "hey infy", "hey infie", "hey infey",
                            "heyy infi", "heyy infee", "heyy infy", "heyy infie", "heyy infey",
                            "heya infi", "heya infee", "heya infy", "heya infie", "heya infey",
                            "yo infi", "yo infee", "yo infy", "yo infie", "yo infey",
                            "sup infi", "sup infee", "sup infy", "sup infie", "sup infey"
                            ];
                        const foundWakeWord = wakeWords.some(word => 
                            transcript.toLowerCase().includes(word)
                        );
                        
                        if (foundWakeWord) {
                            wakeWordDetected = true;
                            const messages = document.getElementById('messages');
                            const botMessage = document.createElement('div');
                            botMessage.className = 'bot-message';
                            botMessage.textContent = "Hello! How can I help you today?";
                            messages.appendChild(botMessage);
                            speakResponse("Hello! How can I help you today?");
                            conversationActive = true;
                            document.querySelector('.mic-container').classList.add('active');
                            return;
                        } else {
                            // Ignore all other input until wake word is detected
                            return;
                        }
                    }

                    // Normal conversation flow
                    const messages = document.getElementById('messages');
                    const userMessage = document.createElement('div');
                    userMessage.className = 'user-message';
                    userMessage.textContent = transcript;
                    messages.appendChild(userMessage);

                    if (["bye", "exit", "goodbye"].some(cmd => transcript.toLowerCase().includes(cmd))) {
                        handleExitCommand();
                        return;
                    }

                    axios.post('/api/gmtt/', { prompt: transcript, job: "general" })
                        .then(response => {
                            const botMessage = document.createElement('div');
                            botMessage.className = 'bot-message';
                            botMessage.textContent = response.data.text;
                            messages.appendChild(botMessage);

                            speakResponse(response.data.text);
                        })
                        .catch(error => {
                            console.error(error);
                            const botMessage = document.createElement('div');
                            botMessage.className = 'bot-message';
                            botMessage.textContent = "Something went wrong. Please try again.";
                            messages.appendChild(botMessage);
                        });
                }
            };

            recognition.onerror = function (event) {
                console.error('Speech recognition error:', event.error);
                isListening = false;
                updateMicButton();
            };

            recognition.onend = function () {
                if (isListening && conversationActive) {
                    recognition.start();
                } else {
                    updateMicButton();
                }
            };

            recognition.start();
        }

        function handleExitCommand() {
            // Requirement 5: Handle exit commands
            speakResponse("Ok bye! Have a good day!");

            // Close mic and reset
            if (isListening) {
                recognition.stop();
                isListening = false;
            }

            // Move animation to bottom
            document.querySelector('.mic-container').classList.remove('active');

            // Reset conversation state
            conversationActive = false;
            wakeWordDetected = false;

            // Update mic button
            updateMicButton();
        }

        function toggleChat() {
            const chatContainer = document.querySelector('.chat-container');
            const micContainer = document.querySelector('.mic-container');
            chatContainer.style.display = chatContainer.style.display === 'flex' ? 'none' : 'flex';
            micContainer.style.display = micContainer.style.display === 'none' ? 'flex' : 'none';
        }

        // Initialize mic on page load
        window.onload = function() {
            startVoiceRecognition();
        };
    </script>
    <script>
        function scrollToBottom() {
            const chatWindow = document.getElementById('chat-window');
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
    </script>
</body>

</html> -->


<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InFi Chatbot</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2e7d32; /* Forest green */
            --secondary-color: #1b5e20; /* Darker green */
            --accent-color: #8bc34a; /* Light green */
            --text-color: #263238; /* Dark blue-gray */
            --light-text: #f1f8e9; /* Light greenish white */
            --background: #e8f5e9; /* Very light green */
            --card-bg: #ffffff;
            --border-color: #c8e6c9; /* Light green border */
            --shadow: 0 4px 12px rgba(46, 125, 50, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--background);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            color: var(--text-color);
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 50%, #a5d6a7 100%);
        }

        .mic-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            transition: all 0.5s ease-in-out;
            z-index: 1000;
            width: 120px;
            height: 120px;
            /* border-radius: 50%; */
            /* background-color: var(--primary-color);
            box-shadow: var(--shadow); */
            /* border: 3px solid var(--accent-color); */
        }

        .mic-container.active {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 300px;
            /* border-radius: 50%;
            background-color: var(--primary-color);
            background-image: radial-gradient(circle, var(--accent-color) 0%, var(--primary-color) 70%); */
        }

        .mic-container.active #mic-btn {
            width: 280px;
            height: 280px;
            /* border-radius: 50%;
            border: 5px solid var(--accent-color); */
        }

        .mic-container.active #mic-btn img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .mic-container.active .mic-status {
            font-size: 18px;
            margin-top: 15px;
            color: var(--light-text);
            font-weight: 500;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        #mic-btn {
            background: none;
            border: none;
            cursor: pointer;
            outline: none;
            padding: 0;
            width: 100px;
            height: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease-in-out;
            border-radius: 50%;
            background-color: var(--primary-color);
            border: 3px solid var(--accent-color);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        #mic-btn img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .mic-status {
            margin-top: 10px;
            font-size: 16px;
            color: var(--light-text);
            text-align: center;
            display: none;
            font-weight: 500;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .mic-container.active .mic-status {
            display: block;
        }

        .chat-container {
            display: none;
            flex-direction: column;
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
            background: var(--card-bg);
            padding: 24px;
            border-radius: 12px;
            height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            transition: all 0.3s ease-in-out;
            background-image: linear-gradient(to bottom, rgba(255,255,255,0.9), rgba(233,245,233,0.9));
            position: relative;
        }

        .chat-container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 10px;
            background: linear-gradient(to right, 
                #8bc34a, #7cb342, #689f38, #558b2f, #2e7d32);
            border-radius: 12px 12px 0 0;
        }

        .chat-container h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 24px;
            font-size: 24px;
            font-weight: 600;
            position: relative;
            padding-bottom: 10px;
        }

        .chat-container h1::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 25%;
            right: 25%;
            height: 2px;
            background: linear-gradient(to right, transparent, var(--accent-color), transparent);
        }

        #chat-window {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 8px;
            background-color: rgba(255,255,255,0.7);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        #messages {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .user-message {
            background: var(--primary-color);
            align-self: flex-end;
            color: var(--light-text);
            text-align: right;
            border-radius: 12px 12px 0 12px;
            box-shadow: var(--shadow);
            border: none;
            position: relative;
        }

        .user-message::after {
            content: "";
            position: absolute;
            bottom: 0;
            right: -10px;
            width: 0;
            height: 0;
            border: 10px solid transparent;
            border-left-color: var(--primary-color);
            border-right: 0;
            margin-top: -10px;
            margin-right: -10px;
        }

        .bot-message {
            background: var(--card-bg);
            align-self: flex-start;
            color: var(--text-color);
            text-align: left;
            border-radius: 12px 12px 12px 0;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            position: relative;
        }

        .bot-message::before {
            content: "";
            position: absolute;
            bottom: 0;
            left: -10px;
            width: 0;
            height: 0;
            border: 10px solid transparent;
            border-right-color: var(--card-bg);
            border-left: 0;
            margin-top: -10px;
            margin-left: -10px;
        }

        #messages>div {
            padding: 12px 16px;
            max-width: 75%;
            line-height: 1.5;
            word-wrap: break-word;
            font-size: 15px;
        }

        form {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }

        input#prompt {
            flex: 1;
            padding: 12px 16px;
            font-size: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--card-bg);
            color: var(--text-color);
            outline: none;
            transition: all 0.3s;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%232e7d32" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 1 0 10 10 4 4 0 0 1-5 3.9 4 4 0 0 1-1-7.8V6a2 2 0 0 1 2-2z"></path></svg>');
            background-repeat: no-repeat;
            background-position: 12px center;
            padding-left: 40px;
        }

        input#prompt:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(46, 125, 50, 0.2);
        }

        form button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        form button:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        #toggle-chat-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--primary-color);
            border: none;
            cursor: pointer;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            z-index: 1001;
            transition: all 0.3s;
            border: 2px solid var(--accent-color);
        }

        #toggle-chat-btn:hover {
            background-color: var(--secondary-color);
            transform: scale(1.05);
        }

        #menu-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--primary-color);
            border: none;
            cursor: pointer;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            z-index: 1001;
            transition: all 0.3s;
            border: 2px solid var(--accent-color);
        }

        #menu-btn:hover {
            background-color: var(--secondary-color);
            transform: scale(1.05);
        }

        @media (max-width: 768px) {
            .mic-container {
                bottom: 10px;
                width: 100px;
                height: 100px;
            }

            .mic-container.active {
                width: 250px;
                height: 250px;
            }

            .mic-container.active #mic-btn {
                width: 230px;
                height: 230px;
            }

            #mic-btn {
                width: 80px;
                height: 80px;
            }

            #toggle-chat-btn,
            #menu-btn {
                top: 20px;
                bottom: auto;
            }

            #toggle-chat-btn {
                right: 20px;
            }

            #menu-btn {
                left: 20px;
            }

            .chat-container {
                height: 90vh;
                border-radius: 0;
                padding: 16px;
            }
        }

        /* Typing indicators */
        .typing-indicator {
            color: #689f38;
            font-style: italic;
            font-size: 14px;
            padding: 8px 16px;
            position: relative;
        }

        .typing-indicator::before {
            content: "üå±";
            margin-right: 5px;
        }

        .user-typing {
            align-self: flex-end;
        }

        .bot-typing {
            align-self: flex-start;
        }

        /* Leaf decoration for messages */
        .user-message::before {
            content: "üçÉ";
            position: absolute;
            left: -25px;
            top: 50%;
            transform: translateY(-50%);
        }

        .bot-message::after {
            content: "üåø";
            position: absolute;
            right: -25px;
            top: 50%;
            transform: translateY(-50%);
        }
    </style>
</head>

<body>
    <button id="menu-btn">
        <i class="fas fa-leaf"></i>
    </button>
    <button id="toggle-chat-btn" onclick="toggleChat()">
        <i class="fas fa-keyboard"></i>
    </button>
    <div class="mic-container">
        <button id="mic-btn" onclick="handleMicClick()">
            <img src="/static/assets/voicegif.gif" alt="Voice GIF">
        </button>
        <div class="mic-status"></div>
    </div>
    <div class="chat-container">
        <h1>InFi Chatbot</h1>
        <div id="chat-window">
            <div id="messages"></div>
        </div>
        <form onsubmit="event.preventDefault(); sendMessage();">
            <input type="text" id="prompt" placeholder="Type your message here..." />
            <button type="submit">
                <i class="fas fa-paper-plane"></i>
            </button>
        </form>
    </div>

    <script>
        let recognition;
        let isListening = false;
        let isBotSpeaking = false;
        let isFirstClick = true;
        let selectedVoice = null;
        let conversationActive = false;
        let wakeWordDetected = false;

        function loadVoices() {
            const voices = window.speechSynthesis.getVoices();
            selectedVoice = voices.find(voice => voice.name.toLowerCase().includes('neerja'));

            if (!selectedVoice) {
                console.warn("Neerja voice not found. Using default voice.");
            }
        }

        if (window.speechSynthesis.getVoices().length > 0) {
            loadVoices();
        } else {
            window.speechSynthesis.onvoiceschanged = loadVoices;
        }

        function sendMessage() {
            const prompt = document.getElementById('prompt').value;
            const messages = document.getElementById('messages');
            if (!prompt.trim()) return;

            const userMessage = document.createElement('div');
            userMessage.className = 'user-message';
            userMessage.textContent = prompt;
            messages.appendChild(userMessage);
            scrollToBottom(); // Auto-scroll after adding user message

            const userTypingIndicator = document.createElement('div');
            userTypingIndicator.className = 'typing-indicator user-typing';
            userTypingIndicator.textContent = 'You are typing...';
            messages.appendChild(userTypingIndicator);
            scrollToBottom(); // Auto-scroll after adding typing indicator

            document.getElementById('prompt').value = '';

            axios.post('/api/gmtt/', { prompt: prompt, job: "general" })
                .then(response => {
                    messages.removeChild(userTypingIndicator);

                    const botTypingIndicator = document.createElement('div');
                    botTypingIndicator.className = 'typing-indicator bot-typing';
                    botTypingIndicator.textContent = 'Bot is typing...';
                    messages.appendChild(botTypingIndicator);
                    scrollToBottom(); // Auto-scroll after adding bot typing indicator

                    setTimeout(() => {
                        messages.removeChild(botTypingIndicator);

                        const botMessage = document.createElement('div');
                        botMessage.className = 'bot-message';
                        botMessage.textContent = response.data.text;
                        messages.appendChild(botMessage);
                        scrollToBottom(); // Auto-scroll after adding bot message

                        if (["bye", "exit", "goodbye"].includes(prompt.toLowerCase())) {
                            handleExitCommand();
                        } else {
                            speakResponse(response.data.text);
                        }
                    }, 1000);
                })
                .catch(error => {
                    console.error(error);
                    messages.removeChild(userTypingIndicator);

                    const botMessage = document.createElement('div');
                    botMessage.className = 'bot-message';
                    botMessage.textContent = "Something went wrong. Please try again.";
                    messages.appendChild(botMessage);
                    scrollToBottom(); // Auto-scroll after error message
                });
        }

        function speakResponse(text) {
            window.speechSynthesis.cancel();

            if (isListening) {
                recognition.stop();
                isListening = false;
                updateMicButton();
            }

            const speech = new SpeechSynthesisUtterance(text);
            speech.lang = 'en-IN';

            if (selectedVoice) {
                speech.voice = selectedVoice;
            }

            speech.onstart = () => {
                isBotSpeaking = true;
                document.getElementById('mic-btn').innerHTML = '<img src="/static/assets/voicegif.gif" alt="Voice Active GIF">';
            };

            speech.onend = () => {
                isBotSpeaking = false;
                if (conversationActive && !isListening) {
                    // Add a small delay before restarting recognition
                    setTimeout(() => {
                        try {
                            if (!isListening) {
                                recognition.start();
                                isListening = true;
                                document.getElementById('mic-btn').innerHTML = '<img src="/static/assets/voicegif.gif" alt="Voice GIF">';
                            }
                        } catch (e) {
                            console.log("Recognition start error:", e);
                            // If start fails, try again after a short delay
                            setTimeout(() => {
                                if (!isListening) {
                                    recognition.start();
                                    isListening = true;
                                    document.getElementById('mic-btn').innerHTML = '<img src="/static/assets/voicegif.gif" alt="Voice GIF">';
                                }
                            }, 500);
                        }
                    }, 500);
                }
            };

            window.speechSynthesis.speak(speech);
        }

        function updateMicButton() {
            const micBtn = document.getElementById('mic-btn');
            if (isBotSpeaking) {
                micBtn.innerHTML = '<img src="/static/assets/voicegif.gif" alt="Voice Active GIF">';
            } else {
                micBtn.innerHTML = isListening
                    ? '<img src="/static/assets/voicegif.gif" alt="Voice GIF">'
                    : '<img src="/static/assets/voicegif.gif" alt="Voice Inactive GIF">';
            }
        }

        function handleMicClick() {
            const micContainer = document.querySelector('.mic-container');
            const micStatus = document.querySelector('.mic-status');

            if (!conversationActive) {
                // First interaction - start conversation
                micContainer.classList.add('active');
                startVoiceRecognition(true);
                conversationActive = true;
                wakeWordDetected = true; // Consider click as wake word
                return;
            }

            if (isBotSpeaking) {
                // Requirement 3: Click while bot is speaking
                window.speechSynthesis.cancel();
                isBotSpeaking = false;
                startVoiceRecognition();
            } else {
                // Toggle between bottom and center positions
                if (micContainer.classList.contains('active')) {
                    // Currently in center - move to bottom
                    micContainer.classList.remove('active');
                    if (isListening) {
                        recognition.stop();
                        isListening = false;
                    }
                } else {
                    // Currently in bottom - move to center and restart
                    micContainer.classList.add('active');
                    startVoiceRecognition();
                }
            }
        }

        function startVoiceRecognition(initialStart = false) {
            if (!('webkitSpeechRecognition' in window)) {
                alert('Speech recognition is not supported in this browser.');
                return;
            }

            if (isListening && !initialStart) {
                recognition.stop();
                isListening = false;
                updateMicButton();
                return;
            }

            // If recognition already exists and is running, stop it first
            if (recognition && isListening) {
                recognition.stop();
                isListening = false;
            }

            recognition = new webkitSpeechRecognition();
            recognition.lang = 'en-IN';
            recognition.interimResults = false;
            recognition.continuous = true;

            recognition.onstart = function () {
                isListening = true;
                document.getElementById('mic-btn').innerHTML = '<img src="/static/assets/voicegif.gif" alt="Voice Active GIF">';
                document.querySelector('.mic-status').textContent = 'Listening...';
                
                if (!wakeWordDetected && !initialStart) {
                    document.querySelector('.mic-status').textContent = 'Hello! I am Infi';
                }
            };

            recognition.onresult = function (event) {
                const transcript = event.results[event.results.length - 1][0].transcript.trim();
                if (transcript) {
                    // Check for wake word if conversation hasn't started yet
                    if (!wakeWordDetected) {
                        const wakeWords = [
                            "hi infi", "hi infee", "hi infy", "hi infie", "hi infey",
                            "hii infi", "hii infee", "hii infy", "hii infie", "hii infey",
                            "hello infi", "hello infee", "hello infy", "hello infie", "hello infey",
                            "helloo infi", "helloo infee", "helloo infy", "helloo infie", "helloo infey",
                            "hey infi", "hey infee", "hey infy", "hey infie", "hey infey",
                            "heyy infi", "heyy infee", "heyy infy", "heyy infie", "heyy infey",
                            "heya infi", "heya infee", "heya infy", "heya infie", "heya infey",
                            "yo infi", "yo infee", "yo infy", "yo infie", "yo infey",
                            "sup infi", "sup infee", "sup infy", "sup infie", "sup infey"
                            ];
                        const foundWakeWord = wakeWords.some(word => 
                            transcript.toLowerCase().includes(word)
                        );
                        
                        if (foundWakeWord) {
                            wakeWordDetected = true;
                            const messages = document.getElementById('messages');
                            const botMessage = document.createElement('div');
                            botMessage.className = 'bot-message';
                            botMessage.textContent = "Hello! How can I help you today?";
                            messages.appendChild(botMessage);
                            speakResponse("Hello! How can I help you today?");
                            conversationActive = true;
                            document.querySelector('.mic-container').classList.add('active');
                            return;
                        } else {
                            // Ignore all other input until wake word is detected
                            return;
                        }
                    }

                    // Normal conversation flow
                    const messages = document.getElementById('messages');
                    const userMessage = document.createElement('div');
                    userMessage.className = 'user-message';
                    userMessage.textContent = transcript;
                    messages.appendChild(userMessage);

                    if (["bye", "exit", "goodbye"].some(cmd => transcript.toLowerCase().includes(cmd))) {
                        handleExitCommand();
                        return;
                    }

                    axios.post('/api/gmtt/', { prompt: transcript, job: "general" })
                        .then(response => {
                            const botMessage = document.createElement('div');
                            botMessage.className = 'bot-message';
                            botMessage.textContent = response.data.text;
                            messages.appendChild(botMessage);

                            speakResponse(response.data.text);
                        })
                        .catch(error => {
                            console.error(error);
                            const botMessage = document.createElement('div');
                            botMessage.className = 'bot-message';
                            botMessage.textContent = "Something went wrong. Please try again.";
                            messages.appendChild(botMessage);
                        });
                }
            };

            recognition.onerror = function (event) {
                console.error('Speech recognition error:', event.error);
                isListening = false;
                updateMicButton();
            };

            recognition.onend = function () {
                if (isListening && conversationActive) {
                    recognition.start();
                } else {
                    updateMicButton();
                }
            };

            recognition.start();
        }

        function handleExitCommand() {
            // Requirement 5: Handle exit commands
            speakResponse("Ok bye! Have a good day!");

            // Close mic and reset
            if (isListening) {
                recognition.stop();
                isListening = false;
            }

            // Move animation to bottom
            document.querySelector('.mic-container').classList.remove('active');

            // Reset conversation state
            conversationActive = false;
            wakeWordDetected = false;

            // Update mic button
            updateMicButton();
        }

        function toggleChat() {
            const chatContainer = document.querySelector('.chat-container');
            const micContainer = document.querySelector('.mic-container');
            chatContainer.style.display = chatContainer.style.display === 'flex' ? 'none' : 'flex';
            micContainer.style.display = micContainer.style.display === 'none' ? 'flex' : 'none';
        }

        // Initialize mic on page load
        window.onload = function() {
            startVoiceRecognition();
        };
    </script>
    <script>
        function scrollToBottom() {
            const chatWindow = document.getElementById('chat-window');
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
    </script>
</body>

</html>